{% extends 'base.html' %}
{% block content %}

<style>
    .step-box { display: none; }
    .step-box.active { display: block; }
    .camera-viewer { 
        width: 100%; 
        max-width: 500px; 
        border: 3px solid #0dcaf0; 
        border-radius: 15px; 
        background: #000;
    }
    .preview-thumbnail {
        width: 120px;
        height: 80px;
        object-fit: cover;
        border: 2px solid #198754;
        border-radius: 5px;
    }
</style>

<div class="container mt-5">
    <div class="row justify-content-center">
        <div class="col-md-7">
            <div class="card bg-dark text-white border-info shadow">
                <div class="card-body p-4">
                    <form id="verificationForm" method="POST">
                        {% csrf_token %}
                        <input type="hidden" name="id_image" id="id_image_data">
                        <input type="hidden" name="face_image" id="face_image_data">

                        <div id="step1" class="step-box active">
                            <h3 class="text-info"><i class="bi bi-person-lines-fill"></i> Step 1: Profile</h3>
                            <hr class="bg-info">
                            <div class="mb-3">
                                <label>Phone Number</label>
                                <input type="text" name="phone_number" class="form-control bg-secondary text-white border-0" placeholder="+1..." required>
                            </div>
                            <div class="mb-3">
                                <label>Occupation</label>
                                <input type="text" name="occupation" class="form-control bg-secondary text-white border-0" placeholder="Engineer, Student, etc." required>
                            </div>
                            <button type="button" class="btn btn-info w-100 fw-bold" onclick="nextStep(2)">NEXT: CAPTURE ID</button>
                        </div>

                        <div id="step2" class="step-box text-center">
                            <h3 class="text-info">Step 2: ID Document</h3>
                            <p class="small text-muted">Hold your ID card clearly in front of the camera</p>
                            <video id="video" class="camera-viewer mb-3" autoplay playsinline></video>
                            <canvas id="canvas" style="display:none;"></canvas>
                            <button type="button" class="btn btn-primary" onclick="capturePhoto('id')">CAPTURE ID</button>
                            <div id="id_status" class="mt-2 text-success" style="display:none;"><i class="bi bi-check-circle"></i> ID Captured!</div>
                            <button type="button" id="btnNext2" class="btn btn-info w-100 mt-3 fw-bold" style="display:none;" onclick="nextStep(3)">NEXT: CAPTURE SELFIE</button>
                        </div>

                        <div id="step3" class="step-box text-center">
                            <h3 class="text-info">Step 3: Face Verification</h3>
                            <p class="small text-muted">Look directly at the camera and smile!</p>
                            <video id="video2" class="camera-viewer mb-3" autoplay playsinline></video>
                            <button type="button" class="btn btn-primary" onclick="capturePhoto('face')">CAPTURE SELFIE</button>
                            <div id="face_status" class="mt-2 text-success" style="display:none;"><i class="bi bi-check-circle"></i> Face Captured!</div>
                            
                            <div id="reviewArea" class="mt-4 p-3 bg-black rounded" style="display:none;">
                                <h5 class="text-white-50">Final Review</h5>
                                <div class="d-flex justify-content-around">
                                    <img id="prev_id" class="preview-thumbnail">
                                    <img id="prev_face" class="preview-thumbnail">
                                </div>
                                <button type="submit" class="btn btn-success w-100 mt-4 py-3 fw-bold">SUBMIT FOR APPROVAL</button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    let currentStream;
    const canvas = document.getElementById('canvas');

    async function startCamera(videoId) {
        if (currentStream) currentStream.getTracks().forEach(track => track.stop());
        currentStream = await navigator.mediaDevices.getUserMedia({ video: true });
        document.getElementById(videoId).srcObject = currentStream;
    }

    function nextStep(step) {
        document.querySelectorAll('.step-box').forEach(el => el.classList.remove('active'));
        document.getElementById('step' + step).classList.add('active');
        if (step === 2) startCamera('video');
        if (step === 3) startCamera('video2');
    }

    function capturePhoto(type) {
        const video = type === 'id' ? document.getElementById('video') : document.getElementById('video2');
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        canvas.getContext('2d').drawImage(video, 0, 0);
        const data = canvas.toDataURL('image/png');

        if (type === 'id') {
            document.getElementById('id_image_data').value = data;
            document.getElementById('id_status').style.display = 'block';
            document.getElementById('btnNext2').style.display = 'block';
            document.getElementById('prev_id').src = data;
        } else {
            document.getElementById('face_image_data').value = data;
            document.getElementById('face_status').style.display = 'block';
            document.getElementById('reviewArea').style.display = 'block';
            document.getElementById('prev_face').src = data;
        }
    }
</script>
{% endblock %}